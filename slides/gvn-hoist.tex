\documentclass{beamer}
\usepackage{hyperref}
\usepackage{graphicx}
\usepackage{amssymb}
\usepackage{graphviz}
\usepackage{tikz}
\usepackage{dot2texi}
\usepackage{listings}

\pgfdeclarelayer{background}
\pgfdeclarelayer{foreground}
\pgfsetlayers{background,main,foreground}

\begin{document}
\def \GVN {GVN}

\title{\GVN{}-Hoist: Hoisting Computations from Branches}
\author{Sebastian Pop and Aditya Kumar}
\institute{SARC: Samsung Austin R\&D Center}
\date{November 3, 2016}

\definecolor{myblue}{rgb}{0.0, 0.0, 0.5}
\definecolor{myred}{rgb}{0.5, 0.0, 0.0}
\definecolor{mygreen}{rgb}{0.0, 0.5, 0.0}
\lstset{language=C++,
  basicstyle=\ttfamily,
  keywordstyle=\color{myblue}\ttfamily,
  stringstyle=\color{myred}\ttfamily,
  commentstyle=\color{mygreen}\ttfamily,
  morecomment=[l][\color{magenta}]{\#}
}
\addtobeamertemplate{navigation symbols}{}{%
    \usebeamerfont{footline}%
    \usebeamercolor[fg]{footline}%
    \hspace{1em}%
    \insertframenumber/\inserttotalframenumber
}

\frame{\titlepage}



\frame{\frametitle{\GVN{}-Hoist: Hoisting Computations from Branches}
  \begin{itemize}
    \item identifies identical computations in a function
    \item hoist identical computations to a common dominator
    \item reduces code size
    \item reduces critical path lenth by exposing more ILP
  \end{itemize}
}

\begin{frame}[fragile]{Example of hoisting}
  \begin{lstlisting}
  if (inv >= 0) {
    tmin = (min - a) * inv;
    tmax = (max - a) * inv;
  } else {
    tmin = (max - a) * inv;
    tmax = (min - a) * inv;
  }
  \end{lstlisting}

  $\hspace{2cm}\Big\downarrow$

  \begin{lstlisting}
  x = (min - a) * inv;
  y = (max - a) * inv;
  if (inv >= 0) {
    tmin = x;
    tmax = y;
  } else {
    tmin = y;
    tmax = x;
  }
  \end{lstlisting}
\end{frame}

\frame{\frametitle{Optimistic \GVN{}-hoist Algorithm}
  \begin{itemize}
  \item compute value number of scalars, loads, stores, calls
  \item compute insertion points of each type of instructions
  \item hoist expressions
  \item propagate changes by upating SSA
  \end{itemize}
}

\frame{\frametitle{\GVN{}-Hoist: Algorithm-collecting value numbers}
  \begin{itemize}
  \item loads: value number the pointer operand
  \item stores: value number the pointer operand and the value being stored
  \item calls, Scalars: use the existing GVN infrastructure
  \end{itemize}
}

\frame{\frametitle{\GVN{}-Hoist: Algorithm-compute insertion points}
  Insertion Point: A location where all the operands are either available
    or, can be made available.

  \begin{itemize}
  \item Compute a common insertion point for a set of instructions having the same GVN.
    (Similar to VBEs but not as strict)
  \item Partition the candidates into a smaller set of hoistable candidates when
    no common insertion points can be found (The instructions are sorted by their DFS numbers)
  \end{itemize}
}

\frame{\frametitle{\GVN{}-Hoist: Algorithm-hoist expressions}
  \begin{itemize}
  \item Scalars: Just move one of the instructions to the hoisting point and remove others. Update SSA.
  \item Loads and Stores: Try to make geps available (if not), and then hoist. Update SSA and memory SSA.
  \item Calls: Hoist just like scalars. Update SSA.
  \item Set minimum alignment among all the candidates for loads and stores, maximum for allocas.
  \end{itemize}
}

\frame{\frametitle{CFGSimplify's code hoisting}
  \begin{itemize}
  \item hoists computations at the beginning of BB
  \item stops at first difference
  \item very fast: disabling slows the compiler: $1688 \to 1692$ Bn insns
  \end{itemize}
}

\frame{\frametitle{GVN hoisting}
  \begin{itemize}
  \item $1\%$ compile time overhead: $1678 \to 1692$ Bn insns
  \item more hoists than CFG-simplify: $15048 \to 25318$
  \end{itemize}

  \begin{center}
    \begin{tabular}{|l|c|}
      \hline
      Scalars hoisted      & 8960  \\\hline
      Scalars removed      & 11940 \\\hline
      Loads hoisted        & 16301 \\\hline
      Loads removed        & 22690 \\\hline
      Stores hoisted       & 50    \\\hline
      Stores removed       & 50    \\\hline
      Calls hoisted        & 7     \\\hline
      Calls removed        & 7     \\\hline
      Total Instructions hoisted & 25318 \\\hline
      Total Instructions removed & 34687 \\\hline
    \end{tabular}
  \end{center}
}

\frame{\frametitle{Cost models}
  \begin{itemize}
  \item Limit the number of Basic Blocks in the path between initial position
    and the hoisting point
  \item Limit the number of instructions between the initial position and the
    beginning of its Basic Block
  \item Do not hoist GEPs
  \item Limit the number of dependent instructions to be hoisted
  \end{itemize}
}

\frame{\frametitle{Code size reduction}
  \begin{center}
    \begin{tabular}{|l|c|}
      \hline
      Code-size metric  (.text)                   & Number   \\\hline
      Total  benchmarks                           & 497      \\\hline
      Total  gained in size                       & 39       \\\hline
      Total  decrease in size                     & 58       \\\hline
      Median decrease in size                     & 2.9\%    \\\hline
      Median increase in size                     & 2.4\%    \\\hline
    \end{tabular}
  \end{center}
}

\end{document}
